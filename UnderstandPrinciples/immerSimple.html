<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <div>
    <h1>immer ç®€æ˜“ç‰ˆå®ç°</h1>
  </div>
  <script>
    /**
 * ç®€æ˜“ç‰ˆ Immer å®ç°
 * æ”¯æŒæ ¸å¿ƒåŠŸèƒ½ï¼šProxy ä»£ç†ã€Copy-on-Writeã€ç»“æ„å…±äº«ã€åµŒå¥—å¯¹è±¡å¤„ç†
 */

// ç”¨äºæ ‡è¯†ä»£ç†å¯¹è±¡çš„ Symbol
const DRAFT_STATE = Symbol('draft-state');
const IS_DRAFT = Symbol('is-draft');

// å·¥å…·å‡½æ•°ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºå¯¹è±¡
function isObject(value) {
  return value !== null && typeof value === 'object';
}

// å·¥å…·å‡½æ•°ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºæ•°ç»„
function isArray(value) {
  return Array.isArray(value);
}

// å·¥å…·å‡½æ•°ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºçº¯å¯¹è±¡
function isPlainObject(value) {
  if (!isObject(value)) return false;
  if (value.constructor !== Object && value.constructor != null) return false;
  return true;
}

// å·¥å…·å‡½æ•°ï¼šæ£€æŸ¥æ˜¯å¦å¯ä»¥è¢«ä»£ç†
function isDraftable(value) {
  return isArray(value) || isPlainObject(value);
}

// å·¥å…·å‡½æ•°ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºä»£ç†å¯¹è±¡
function isDraft(value) {
  return Boolean(value && value[IS_DRAFT]);
}

// å·¥å…·å‡½æ•°ï¼šè·å–ä»£ç†å¯¹è±¡çš„çŠ¶æ€
function getDraftState(draft) {
  return draft[DRAFT_STATE];
}

/**
 * Draft çŠ¶æ€ç±»
 * ç®¡ç†æ¯ä¸ªä»£ç†å¯¹è±¡çš„çŠ¶æ€ä¿¡æ¯
 */
class DraftState {
  constructor(base, parent, key) {
    this.base = base;           // åŸå§‹å¯¹è±¡
    this.parent = parent;       // çˆ¶çº§çŠ¶æ€
    this.key = key;            // åœ¨çˆ¶çº§ä¸­çš„é”®
    this.copy = null;          // å¤åˆ¶å¯¹è±¡ï¼ˆå†™æ—¶å¤åˆ¶ï¼‰
    this.modified = false;     // æ˜¯å¦è¢«ä¿®æ”¹
    this.assigned = new Set(); // å·²èµ‹å€¼çš„é”®é›†åˆ
    this.finished = false;     // æ˜¯å¦å·²å®Œæˆ
    this.finalized = false;    // æ˜¯å¦å·²æœ€ç»ˆåŒ–
    this.drafts = new Map();   // å­ä»£ç†å¯¹è±¡ç¼“å­˜
  }

  // è·å–æºå¯¹è±¡ï¼ˆå¤åˆ¶å¯¹è±¡æˆ–åŸå§‹å¯¹è±¡ï¼‰
  get source() {
    return this.copy || this.base;
  }

  // æ ‡è®°ä¸ºå·²ä¿®æ”¹
  markChanged() {
    if (!this.modified) {
      this.modified = true;
      // å‘ä¸Šä¼ æ’­ä¿®æ”¹æ ‡è®°
      if (this.parent) {
        this.parent.markChanged();
      }
    }
  }

  // æ‰§è¡Œå†™æ—¶å¤åˆ¶
  prepareCopy() {
    if (!this.copy) {
      this.copy = isArray(this.base) ? [...this.base] : { ...this.base };
    }
  }
}

/**
 * åˆ›å»ºä»£ç†å¯¹è±¡
 */
function createProxy(base, parent, key) {
  // å¦‚æœä¸å¯ä»£ç†ï¼Œç›´æ¥è¿”å›
  if (!isDraftable(base)) {
    return base;
  }

  // å¦‚æœå·²ç»æ˜¯ä»£ç†å¯¹è±¡ï¼Œç›´æ¥è¿”å›
  if (isDraft(base)) {
    return base;
  }

  // åˆ›å»ºçŠ¶æ€å¯¹è±¡
  const state = new DraftState(base, parent, key);

  // åˆ›å»ºä»£ç†
  const proxy = new Proxy(base, {
    get(target, prop) {
      // è¿”å›æ ‡è¯†ç¬¦
      if (prop === IS_DRAFT) return true;
      if (prop === DRAFT_STATE) return state;

      const { source, drafts } = state;
      const value = source[prop];

      // å¦‚æœæ˜¯å·²ç¼“å­˜çš„å­ä»£ç†ï¼Œç›´æ¥è¿”å›
      if (drafts.has(prop)) {
        return drafts.get(prop);
      }

      // å¦‚æœå€¼ä¸å¯ä»£ç†ï¼Œç›´æ¥è¿”å›
      if (!isDraftable(value)) {
        return value;
      }

      // åˆ›å»ºå­ä»£ç†å¹¶ç¼“å­˜
      const childDraft = createProxy(value, state, prop);
      drafts.set(prop, childDraft);
      return childDraft;
    },

    set(target, prop, value) {
      const { base, source } = state;
      const oldValue = source[prop];

      // æ£€æŸ¥å€¼æ˜¯å¦çœŸçš„æ”¹å˜äº†
      if (oldValue === value && prop in base) {
        return true;
      }

      // æ ‡è®°ä¸ºå·²ä¿®æ”¹å¹¶å‡†å¤‡å¤åˆ¶
      state.markChanged();
      state.prepareCopy();
      state.assigned.add(prop);

      // å¦‚æœè®¾ç½®çš„æ˜¯ä»£ç†å¯¹è±¡ï¼Œéœ€è¦è·å–å…¶æœ€ç»ˆå€¼
      if (isDraft(value)) {
        const draftState = getDraftState(value);
        value = draftState.copy || draftState.base;
      }

      // è®¾ç½®å€¼
      state.copy[prop] = value;
      return true;
    },

    deleteProperty(target, prop) {
      const { base } = state;
      
      // å¦‚æœåŸå§‹å¯¹è±¡ä¸­ä¸å­˜åœ¨è¯¥å±æ€§ï¼Œæ— éœ€æ“ä½œ
      if (!(prop in base)) {
        return true;
      }

      // æ ‡è®°ä¸ºå·²ä¿®æ”¹å¹¶å‡†å¤‡å¤åˆ¶
      state.markChanged();
      state.prepareCopy();
      state.assigned.add(prop);

      // åˆ é™¤å±æ€§
      delete state.copy[prop];
      return true;
    },

    has(target, prop) {
      const { source } = state;
      return prop in source;
    },

    ownKeys(target) {
      const { source } = state;
      return Reflect.ownKeys(source);
    },

    getOwnPropertyDescriptor(target, prop) {
      const { source } = state;
      return Reflect.getOwnPropertyDescriptor(source, prop);
    }
  });

  return proxy;
}

/**
 * æœ€ç»ˆåŒ–ä»£ç†å¯¹è±¡ï¼Œç”Ÿæˆä¸å¯å˜ç»“æœ
 */
function finalize(draft) {
  if (!isDraft(draft)) {
    return draft;
  }

  const state = getDraftState(draft);
  
  // å¦‚æœå·²ç»æœ€ç»ˆåŒ–ï¼Œç›´æ¥è¿”å›ç»“æœ
  if (state.finalized) {
    return state.copy || state.base;
  }

  // æ ‡è®°ä¸ºå·²æœ€ç»ˆåŒ–
  state.finalized = true;

  // å¦‚æœæ²¡æœ‰ä¿®æ”¹ï¼Œè¿”å›åŸå§‹å¯¹è±¡ï¼ˆç»“æ„å…±äº«ï¼‰
  if (!state.modified) {
    return state.base;
  }

  // ç¡®ä¿æœ‰å¤åˆ¶å¯¹è±¡
  state.prepareCopy();
  const result = state.copy;

  // é€’å½’æœ€ç»ˆåŒ–æ‰€æœ‰å­ä»£ç†
  state.drafts.forEach((childDraft, key) => {
    const finalizedChild = finalize(childDraft);
    if (finalizedChild !== state.base[key]) {
      result[key] = finalizedChild;
    }
  });

  // å†»ç»“ç»“æœå¯¹è±¡ï¼ˆå¯é€‰ï¼Œæ¨¡æ‹Ÿä¸å¯å˜æ€§ï¼‰
  Object.freeze(result);
  
  return result;
}

/**
 * ä¸»è¦çš„ produce å‡½æ•°
 */
function produce(base, recipe) {
  // å‚æ•°æ ¡éªŒ
  if (typeof recipe !== 'function') {
    throw new Error('Recipe must be a function');
  }

  // å¦‚æœ base ä¸å¯ä»£ç†ï¼Œç›´æ¥è¿”å›ï¼ˆä¾‹å¦‚åŸºæœ¬ç±»å‹ï¼‰
  if (!isDraftable(base)) {
    const result = recipe(base);
    return result === undefined ? base : result;
  }

  // åˆ›å»ºä»£ç†å¯¹è±¡
  const draft = createProxy(base);

  // æ‰§è¡Œ recipe å‡½æ•°
  const result = recipe(draft);

  // å¦‚æœ recipe è¿”å›äº†å€¼ï¼Œä½¿ç”¨è¿”å›å€¼
  if (result !== undefined) {
    return result;
  }

  // å¦åˆ™æœ€ç»ˆåŒ– draft å¹¶è¿”å›
  return finalize(draft);
}

/**
 * è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºè‰ç¨¿çŠ¶æ€
 */
function createDraft(base) {
  if (!isDraftable(base)) {
    throw new Error('Base must be an object or array');
  }
  return createProxy(base);
}

/**
 * è¾…åŠ©å‡½æ•°ï¼šå®Œæˆè‰ç¨¿çŠ¶æ€
 */
function finishDraft(draft) {
  return finalize(draft);
}

// å¯¼å‡º API
const SimpleImmer = {
  produce,
  createDraft,
  finishDraft,
  isDraft,
  
  // ä¾¿æ·æ–¹æ³•
  applyPatches: (base, patches) => {
    // ç®€åŒ–çš„ patch åº”ç”¨ï¼ˆå®é™… Immer æ”¯æŒ JSON Patchï¼‰
    return produce(base, draft => {
      patches.forEach(patch => {
        if (patch.op === 'replace') {
          const keys = patch.path.split('/').filter(Boolean);
          let target = draft;
          for (let i = 0; i < keys.length - 1; i++) {
            target = target[keys[i]];
          }
          target[keys[keys.length - 1]] = patch.value;
        }
      });
    });
  }
};

// æµ‹è¯•ç”¨ä¾‹
function runTests() {
  console.log('ğŸ§ª å¼€å§‹æµ‹è¯•ç®€æ˜“ç‰ˆ Immer...\n');

  // æµ‹è¯• 1: åŸºæœ¬å¯¹è±¡ä¿®æ”¹
  console.log('ğŸ“ æµ‹è¯• 1: åŸºæœ¬å¯¹è±¡ä¿®æ”¹');
  const baseState = { a: 1, b: { c: 2 } };
  const newState = SimpleImmer.produce(baseState, draft => {
    draft.a = 2;
    draft.b.c = 3;
  });
  console.log('åŸå§‹çŠ¶æ€:', baseState);
  console.log('æ–°çŠ¶æ€:', newState);
  console.log('å¼•ç”¨ä¸åŒ:', newState !== baseState);
  console.log('ç»“æ„å…±äº« b:', newState.b !== baseState.b);
  console.log('');

  // æµ‹è¯• 2: æ•°ç»„æ“ä½œ
  // console.log('ğŸ“ æµ‹è¯• 2: æ•°ç»„æ“ä½œ');
  // const arrayState = [1, 2, { x: 3 }];
  // const newArray = SimpleImmer.produce(arrayState, draft => {
  //   draft.push(4);
  //   draft[2].x = 30;
  // });
  // console.log('åŸå§‹æ•°ç»„:', arrayState);
  // console.log('æ–°æ•°ç»„:', newArray);
  // console.log('å¼•ç”¨ä¸åŒ:', newArray !== arrayState);
  // console.log('');

  // // æµ‹è¯• 3: æ— ä¿®æ”¹æ—¶çš„ç»“æ„å…±äº«
  // console.log('ğŸ“ æµ‹è¯• 3: æ— ä¿®æ”¹æ—¶çš„ç»“æ„å…±äº«');
  // const unchanged = SimpleImmer.produce(baseState, draft => {
  //   // ä¸åšä»»ä½•ä¿®æ”¹
  // });
  // console.log('æ— ä¿®æ”¹æ—¶å¼•ç”¨ç›¸åŒ:', unchanged === baseState);
  // console.log('');

  // æµ‹è¯• 4: å¤æ‚åµŒå¥—ç»“æ„
  // console.log('ğŸ“ æµ‹è¯• 4: å¤æ‚åµŒå¥—ç»“æ„');
  // const complexState = {
  //   users: [
  //     { id: 1, name: 'John', profile: { age: 30 } },
  //     { id: 2, name: 'Jane', profile: { age: 25 } }
  //   ],
  //   settings: { theme: 'dark' }
  // };
  
  // const newComplex = SimpleImmer.produce(complexState, draft => {
  //   draft.users[0].profile.age = 31;
  //   draft.users.push({ id: 3, name: 'Bob', profile: { age: 28 } });
  // });
  
  // console.log('åŸå§‹å¤æ‚çŠ¶æ€:', JSON.stringify(complexState, null, 2));
  // console.log('æ–°å¤æ‚çŠ¶æ€:', JSON.stringify(newComplex, null, 2));
  // console.log('settings ç»“æ„å…±äº«:', newComplex.settings === complexState.settings);
  // console.log('æœªä¿®æ”¹ç”¨æˆ·ç»“æ„å…±äº«:', newComplex.users[1] === complexState.users[1]);
  // console.log('');

  // æµ‹è¯• 5: Draft æ£€æµ‹
  // console.log('ğŸ“ æµ‹è¯• 5: Draft æ£€æµ‹');
  // SimpleImmer.produce(baseState, draft => {
  //   console.log('æ˜¯å¦ä¸º draft:', SimpleImmer.isDraft(draft));
  //   console.log('åµŒå¥—å¯¹è±¡æ˜¯å¦ä¸º draft:', SimpleImmer.isDraft(draft.b));
  // });
  // console.log('');

  console.log('âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆï¼');
}

// å¦‚æœåœ¨ Node.js ç¯å¢ƒä¸­è¿è¡Œæµ‹è¯•
if (typeof module !== 'undefined' && module.exports) {
  module.exports = SimpleImmer;
  // runTests();
} else {
  // æµè§ˆå™¨ç¯å¢ƒ
  window.SimpleImmer = SimpleImmer;
}

// è¿è¡Œæµ‹è¯•ï¼ˆå–æ¶ˆæ³¨é‡Šä»¥è¿è¡Œï¼‰
runTests();
  </script>
</body>
</html>